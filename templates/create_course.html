<!DOCTYPE html>
<html>
<head>
    <title>{{ username }}'s Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='w3.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <style>
        .w3-course-form-card {
            max-width: 700px;
            margin: 0 auto;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        .w3-hover-rounded:hover {
            border-radius: 8px;
        }
        .w3-inline {
            display: flex;
            align-items: center;
        }
        .schedule-entry {
            position: relative;
        }
        .remove-schedule-btn {
            margin-top: 28px;
            position: relative;
            bottom: 5px;
        }
        .right-align {
            align-items: right;
        }
    </style>
</head>

<body class="w3-light-grey">

<!-- Top Navigation -->
<div class="w3-top">
    <div class="w3-bar w3-deep-purple w3-card">
        <a href="/dashboard" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="/courses" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-book"></i> Courses
        </a> 
        <a href="/calendar" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-calendar"></i> Calendar
        </a>
        <button class="w3-button w3-padding-large w3-right w3-hover-rounded" onclick="w3_open()">
            <i class="fas fa-user-circle"></i> {{ username }}
        </button>
    </div>
</div>

<!-- Right Sidebar -->
<div class="w3-sidebar w3-bar-block w3-white w3-card w3-animate-right" 
     style="width:280px;right:0;display:none;z-index:3" id="mySidebar">
    <button onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-right-align">
        <i class="fas fa-times"></i>
    </button>
    <div class="w3-container w3-padding-16 w3-center">
        <h3 class="w3-margin-top"><b>{{ username }}</b></h3>
        <span class="w3-tag w3-round w3-deep-purple">{{ role|capitalize }}</span>
    </div>
    <div class="w3-bar-block">
        <a href="/profile" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-user w3-margin-right"></i> Profile
        </a>
        <a href="/settings" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-cog w3-margin-right"></i> Settings
        </a>
        <a href="/logout" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-sign-out-alt w3-margin-right"></i> Logout
        </a>
    </div>
</div>

<!-- Overlay -->
<div class="w3-overlay w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" id="myOverlay"></div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="w3-panel">
        {% for category, message in messages %}
            <div class="w3-padding w3-{{ 'green' if category == 'success' else 'red' }} w3-round w3-margin-bottom" 
                 id="flash-{{ loop.index }}"
                 style="position: relative; top: 35px">
                {{ message }}
                <span onclick="dismissFlash(this.parentElement)" 
                      class="w3-button w3-right w3-hover-none" 
                      style="position: absolute; right: 0; top: 0; padding: 8px 16px;">
                    &times;
                </span>
            </div>
            <script>
                setTimeout(function() {
                    var flashMsg = document.getElementById('flash-{{ loop.index }}');
                    if (flashMsg) {
                        var opacity = 1;
                        var fadeEffect = setInterval(function() {
                            if (opacity > 0) {
                                opacity -= 0.1;
                                flashMsg.style.opacity = opacity;
                            } else {
                                clearInterval(fadeEffect);
                                flashMsg.style.display = 'none';
                            }
                        }, 50);
                    }
                }, 5000);
                
                function dismissFlash(element) {
                    element.style.display = 'none';
                }
            </script>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="w3-main" style="margin-top:46px">
    <header class="w3-container w3-padding-32 w3-center">
        <h1><b>Create New Course</b></h1>
        <p class="w3-text-grey">Fill out the form to create a new course</p>
        <div class="w3-col m2 w3-right">
            <a href="/courses" class="w3-button w3-deep-purple w3-round-large">
                <i class="fas fa-arrow-left w3-margin-right"></i> Back to Courses
            </a>
        </div>
    </header>

    <!-- Course Form -->
    <div class="w3-container w3-padding-16">
        <div class="w3-course-form-card w3-card w3-white w3-round-large" style="max-width: 800px;">
            <div class="w3-container w3-deep-purple w3-round-large w3-padding-16 w3-center">
                <h3><i class="fas fa-chalkboard-teacher w3-margin-right"></i> Course Details</h3>
            </div>
            <form method="POST" class="w3-container w3-padding-24">
                <div class="w3-section">
                    <div class="w3-inline">
                        <label><b><i class="fas fa-book w3-margin-right w3-text-deep-purple w3-margin-left"></i>Course Name</b></label>
                        <input class="w3-input w3-border w3-round-large w3-margin-left w3-col s9" type="text" name="name" required placeholder="Enter course name">
                    </div>
                    <div id="schedules">
                        <div class="schedule-entry w3-margin-top w3-margin-bottom">
                            <div class="w3-row-padding">
                                <div class="w3-col s4">
                                    <label><b><i class="fas fa-calendar-day w3-margin-right w3-text-deep-purple"></i>Day</b></label>
                                    <select class="w3-select w3-border w3-round-large" name="day[]" required>
                                        <option value="" disabled selected>Select day</option>
                                        <option value="Saturday">Saturday</option>
                                        <option value="Sunday">Sunday</option>
                                        <option value="Monday">Monday</option>
                                        <option value="Tuesday">Tuesday</option>
                                        <option value="Wednesday">Wednesday</option>
                                        <option value="Thursday">Thursday</option>
                                        <option value="Friday">Friday</option>
                                    </select>
                                </div>
                                <div class="w3-col s2">
                                    <label><b><i class="fas fa-clock w3-margin-right w3-text-deep-purple"></i>Time</b></label>
                                    <input class="w3-input w3-border w3-round-large timePicker" type="time" name="time[]" required>
                                </div>
                                <div class="w3-col s4">
                                    <label><b><i class="fas fa-hourglass-half w3-margin-right w3-text-deep-purple"></i>Duration (hours)</b></label>
                                    <input class="w3-input w3-border w3-round-large" type="number" name="duration[]" min="1" max="8" value="1" required>
                                </div>
                                <div class="w3-col s2">
                                    <button type="button" class="w3-button w3-red w3-round-large w3-small remove-schedule-btn" onclick="removeSchedule(this)" style="display: none;">
                                        <i class="fas fa-trash"></i> Remove
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="w3-center">
                        <button type="button" onclick="addSchedule()" class="w3-button w3-medium w3-center w3-deep-purple w3-round-large w3-margin-bottom">
                            <i class="fas fa-plus w3-margin-right"></i> Add Another Schedule
                        </button>
                    </div>
                    
                    <div class="w3-inline" style="position: relative; margin-left: 225px; margin-right: 225px;">
                        <label><b><i class="fas fa-users w3-margin-right w3-text-deep-purple w3-margin-left"></i>Maximum Students</b></label>
                        <input class="w3-input w3-border w3-round-large w3-margin-left w3-col s3" type="number" name="max_students" min="1" value="20" required>
                    </div>
                    
                    <div class="w3-section w3-center">
                        <button type="submit" class="w3-button w3-green w3-round-large w3-padding-large">
                            <i class="fas fa-save w3-margin-right"></i> Create Course
                        </button>
                        <a href="/courses" class="w3-button w3-light-gray w3-round-large w3-padding-large w3-margin-left">
                            <i class="fas fa-times w3-margin-right"></i> Cancel
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize flatpickr for initial time input
        initializeFlatpickr();
    });

    function initializeFlatpickr(element) {
        const inputs = element ? [element] : document.querySelectorAll('.timePicker');
        inputs.forEach(input => {
            flatpickr(input, {
                enableTime: true,
                noCalendar: true,
                dateFormat: "H:i",
                time_24hr: true,
                defaultHour: 8
            });
        });
    }

    function addSchedule() {
        const schedules = document.getElementById('schedules');
        const lastSchedule = schedules.lastElementChild;
        const newSchedule = schedules.children[0].cloneNode(true);
        
        // Get the duration value from the last schedule
        const lastDuration = lastSchedule.querySelector('input[name="duration[]"]').value;
        
        // Clear the values except duration
        newSchedule.querySelectorAll('input').forEach(input => {
            if (input.name === "duration[]") {
                input.value = lastDuration; // Set the same duration as the last schedule
            } else {
                input.value = ''; // Clear other inputs
            }
        });
        newSchedule.querySelector('select').selectedIndex = 0;
        
        // Show the remove button for the new schedule
        const newRemoveBtn = newSchedule.querySelector('.remove-schedule-btn');
        newRemoveBtn.style.display = 'inline-block';
        
        // If this is the second schedule, show the remove button for the first one too
        if (schedules.children.length === 1) {
            const firstRemoveBtn = schedules.children[0].querySelector('.remove-schedule-btn');
            firstRemoveBtn.style.display = 'inline-block';
        }
        
        schedules.appendChild(newSchedule);
        
        // Initialize flatpickr for the new time input
        const newTimeInput = newSchedule.querySelector('.timePicker');
        initializeFlatpickr(newTimeInput);
    }

    function removeSchedule(button) {
        const schedules = document.getElementById('schedules');
        const scheduleEntries = schedules.querySelectorAll('.schedule-entry');
        
        if (scheduleEntries.length > 1) {
            button.closest('.schedule-entry').remove();
            
            // If only one schedule remains, hide its remove button
            if (schedules.children.length === 1) {
                const remainingRemoveBtn = schedules.querySelector('.remove-schedule-btn');
                if (remainingRemoveBtn) {
                    remainingRemoveBtn.style.display = 'none';
                }
            }
        }
    }

    function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("myOverlay").style.display = "block";
    }

    function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("myOverlay").style.display = "none";
    }

    // Form validation before submission
    document.querySelector('form').onsubmit = function(e) {
        const schedules = document.getElementById('schedules').children;
        let hasConflicts = false;
        
        // Check for schedule conflicts within the form
        const scheduleTimes = [];
        for (let i = 0; i < schedules.length; i++) {
            const day = schedules[i].querySelector('select[name="day[]"]').value;
            const time = schedules[i].querySelector('input[name="time[]"]').value;
            const duration = parseInt(schedules[i].querySelector('input[name="duration[]"]').value);
            
            for (let j = 0; j < scheduleTimes.length; j++) {
                if (scheduleTimes[j].day === day) {
                    const time1 = convertTimeToMinutes(time);
                    const time2 = convertTimeToMinutes(scheduleTimes[j].time);
                    const end1 = time1 + (duration * 60);
                    const end2 = time2 + (scheduleTimes[j].duration * 60);
                    
                    if (!(end1 <= time2 || end2 <= time1)) {
                        alert(`Schedule conflict detected on ${day} between ${time} and ${scheduleTimes[j].time}`);
                        hasConflicts = true;
                        break;
                    }
                }
            }
            
            if (hasConflicts) break;
            scheduleTimes.push({ day, time, duration });
        }
        
        if (hasConflicts) {
            e.preventDefault();
            return false;
        }
        return true;
    };

    function convertTimeToMinutes(timeStr) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        return hours * 60 + minutes;
    }
</script>
</body>
</html>