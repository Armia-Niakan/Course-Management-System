<!DOCTYPE html>
<html>
<head>
    <title>{{ course.name }} - Course Details</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='w3.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .w3-hover-rounded:hover {
            border-radius: 8px;
        }
        .course-header {
            background-color: #f8f9fa;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }        
        .removeBtn {
            position: absolute;
            right: 600px;
        }
    </style>
</head>

<body class="w3-light-grey">

<!-- Top Navigation -->
<div class="w3-top">
    <div class="w3-bar w3-deep-purple w3-card">
        <a href="/dashboard" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="/courses" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-book"></i> Courses
        </a> 
        <a href="/calendar" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-calendar"></i> Calendar
        </a>
        <button class="w3-button w3-padding-large w3-right w3-hover-rounded" onclick="w3_open()">
            <i class="fas fa-user-circle"></i> {{ username }}
        </button>
    </div>
</div>

<!-- Right Sidebar -->
<div class="w3-sidebar w3-bar-block w3-white w3-card w3-animate-right" 
     style="width:280px;right:0;display:none;z-index:3" id="mySidebar">
    <button onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-right-align">
        <i class="fas fa-times"></i>
    </button>
    <div class="w3-container w3-padding-16 w3-center">
        <div class="w3-display-container" style="width:100%"></div>
        <h3 class="w3-margin-top"><b>{{ username }}</b></h3>
        <span class="w3-tag w3-round w3-deep-purple">{{ role|capitalize }}</span>
    </div>
    <div class="w3-bar-block">
        <a href="/profile" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-user w3-margin-right"></i> Profile
        </a>
        <a href="/settings" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-cog w3-margin-right"></i> Settings
        </a>
        <a href="/logout" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-sign-out-alt w3-margin-right"></i> Logout
        </a>
    </div>
</div>

<!-- Overlay -->
<div class="w3-overlay w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" id="myOverlay"></div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="w3-panel">
        {% for category, message in messages %}
            <div class="w3-padding w3-{{ 'green' if category == 'success' else 'red' }} w3-round w3-margin-bottom" 
                 id="flash-{{ loop.index }}"
                 style="position: relative; top: 35px">
                {{ message }}
                <span onclick="dismissFlash(this.parentElement)" 
                      class="w3-button w3-right w3-hover-none" 
                      style="position: absolute; right: 0; top: 0; padding: 8px 16px;">
                    &times;
                </span>
            </div>
            <script>
                setTimeout(function() {
                    var flashMsg = document.getElementById('flash-{{ loop.index }}');
                    if (flashMsg) {
                        var opacity = 1;
                        var fadeEffect = setInterval(function() {
                            if (opacity > 0) {
                                opacity -= 0.1;
                                flashMsg.style.opacity = opacity;
                            } else {
                                clearInterval(fadeEffect);
                                flashMsg.style.display = 'none';
                            }
                        }, 50);
                    }
                }, 5000);
                
                function dismissFlash(element) {
                    element.style.display = 'none';
                }
            </script>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="w3-main" style="margin-top:46px;margin-right:0">
    <!-- Course Header -->
    <div class="w3-container w3-padding-32">
        <div class="w3-panel course-header w3-card">
            <div class="w3-row">
                <div class="w3-twothird">
                    <h1><b>{{ course.name }}</b></h1>
                    <p class="w3-large">Taught by {{ course.teacher_name }}</p>
                </div>
                <div class="w3-third w3-right-align">
                    <span class="w3-tag w3-round w3-{{ 'red' if is_full else 'green' }} w3-large">
                        {{ course.current_students }}/{{ course.max_students }} Students
                    </span>
                    <p class="w3-margin-top">
                        <i class="fas fa-calendar-day w3-text-deep-purple"></i> {{ course.day }} at {{ course.time }}
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="w3-container">
        <div class="w3-row-padding">
            <!-- Left Column - Course Details -->
            <div class="w3-twothird">
                <div class="w3-panel w3-white w3-round-large w3-card w3-padding">
                    <h2 class="w3-text-deep-purple"><i class="fas fa-info-circle"></i> Course Information</h2>
                    <div class="w3-row-padding w3-margin-top">
                        <div class="w3-half">
                            <div class="w3-panel">
                                <h4><b><i class="fas fa-clock w3-text-deep-purple"></i> Schedule</b></h4>
                                {% for schedule in course.schedule %}
                                <div class="w3-card w3-round-large w3-padding-small w3-margin-bottom">
                                    <p><i class="fas fa-calendar w3-margin-right"></i> {{ schedule.day }}</p>
                                    <p><i class="fas fa-clock w3-margin-right"></i> {{ schedule.time }}</p>
                                    <p><i class="fas fa-hourglass w3-margin-right"></i> {{ schedule.duration }} hour session</p>
                                    {% if schedule == current_schedule %}
                                        <span class="w3-tag w3-green w3-round">Current Session</span>
                                    {% elif schedule == next_schedule %}
                                        <span class="w3-tag w3-blue w3-round">Next Session</span>
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="w3-half">
                            <div class="w3-panel">
                                <h4><b><i class="fas fa-chalkboard-teacher w3-text-deep-purple"></i> Instructor</b></h4>
                                <p>{{ course.teacher_name }}</p>
                                <h4 class="w3-margin-top"><b><i class="fas fa-hashtag w3-text-deep-purple"></i> Course ID</b></h4>
                                <p>{{ course.id }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Student List (for teachers who own this course) -->
                {% if is_teacher_of_course %}
                <div class="w3-panel w3-white w3-round-large w3-card w3-padding w3-margin-top">
                    <h2 class="w3-text-deep-purple"><i class="fas fa-users"></i> Enrolled Students</h2>
                    {% if students %}
                        <ul class="w3-ul student-list">
                            {% for student in students %}
                            <li class="w3-bar">
                                <div class="w3-bar-item">
                                    <span class="w3-large">{{ student.username }}</span><br>
                                    <span class="w3-small">{{ student.email }}</span>
                                </div>
                                <div class="w3-bar-item w3-bar-right">
                                    <form action="{{ url_for('remove_student') }}" method="POST">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <input type="hidden" name="student_email" value="{{ student.email }}">
                                        <input type="hidden" name="course_name" value="{{ course.name }}">
                                        <button type="submit" class="w3-button w3-red w3-small w3-round-large w3-margin-top removeBtn" 
                                                onclick="return confirm('Are you sure you want to remove this student?')">
                                            <i class="fas fa-user-minus"></i> Remove
                                        </button>
                                    </form>
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="w3-panel w3-pale-yellow w3-round-large">
                            <p><i class="fas fa-info-circle"></i> No students have enrolled yet.</p>
                        </div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Actions -->
            <div class="w3-third">
                <div class="w3-panel w3-white w3-round-large w3-card w3-padding">
                    <h2 class="w3-text-deep-purple"><i class="fas fa-cogs"></i> Actions</h2>
                    <div class="w3-center w3-padding-16">
                        {% if role == 'student' %}
                            {% if is_enrolled %}
                                <form action="{{ url_for('unenroll_course') }}" method="POST">
                                    <input type="hidden" name="course_id" value="{{ course.id }}">
                                    <button type="submit" class="w3-button w3-red w3-round-large w3-padding-large w3-block">
                                        <i class="fas fa-user-minus w3-margin-right"></i> Unenroll
                                    </button>
                                </form>
                            {% else %}
                                {% if is_full %}
                                    <button class="w3-button w3-grey w3-round-large w3-padding-large w3-block" disabled>
                                        <i class="fas fa-lock w3-margin-right"></i> Course Full
                                    </button>
                                {% else %}
                                    <form action="{{ url_for('enroll_course') }}" method="POST">
                                        <input type="hidden" name="course_id" value="{{ course.id }}">
                                        <button type="submit" class="w3-button w3-deep-purple w3-round-large w3-padding-large w3-block">
                                            <i class="fas fa-user-plus w3-margin-right"></i> Enroll Now
                                        </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% elif is_teacher_of_course %}
                            <!-- Teacher actions (only shown if teacher owns this course) -->
                            <form action="{{ url_for('delete_course') }}" method="POST" class="w3-margin-bottom">
                                <input type="hidden" name="course_id" value="{{ course.id }}">
                                <button type="submit" class="w3-button w3-red w3-round-large w3-padding-large w3-block"
                                        onclick="return confirm('Are you sure you want to delete this course? This action cannot be undone.')">
                                    <i class="fas fa-trash-alt w3-margin-right"></i> Delete Course
                                </button>
                            </form>
                        {% endif %}
                        <a href="/courses" class="w3-button w3-light-grey w3-round-large w3-padding-large w3-block w3-margin-top">
                            <i class="fas fa-arrow-left w3-margin-right"></i> Back to Courses
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Sidebar Scripts -->
<script>
    function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("myOverlay").style.display = "block";
    }

    function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("myOverlay").style.display = "none";
    }
</script>

</body>
</html>