<!DOCTYPE html>
<html>
<head>
    <title>{{ username }}'s Dashboard</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='w3.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<style>
    .w3-hover-rounded:hover {
      border-radius: 8px;
    }
</style>

<body class="w3-light-grey">

<!-- Top Navigation -->
<div class="w3-top">
    <div class="w3-bar w3-deep-purple w3-card">
        <a href="{{ url_for('main.dashboard') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-tachometer-alt"></i> Dashboard
        </a>
        <a href="{{ url_for('course.courses') }}" class="w3-bar-item w3-button w3-padding-large w3-round-large w3-white">
            <i class="fas fa-book"></i> Courses
        </a> 
        <a href="{{ url_for('exam.exams_page') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-file-signature"></i> Exams
        </a>
        <a href="{{ url_for('course.calendar') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
            <i class="fas fa-calendar"></i> Calendar
        </a>
        <button class="w3-button w3-padding-large w3-right w3-hover-rounded" onclick="w3_open()">
            <i class="fas fa-user-circle"></i> {{ username }}
        </button>
    </div>
</div>

<!-- Right Sidebar -->
<div class="w3-sidebar w3-bar-block w3-white w3-card w3-animate-right" 
     style="width:280px;right:0;display:none;z-index:3" id="mySidebar">
    <button onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-right-align">
        <i class="fas fa-times"></i>
    </button>
    <div class="w3-container w3-padding-16 w3-center">
        <div class="w3-display-container" style="width:100%"></div>
        <h3 class="w3-margin-top"><b>{{ username }}</b></h3>
        <span class="w3-tag w3-round w3-deep-purple">{{ role|capitalize }}</span>
    </div>
    <div class="w3-bar-block">
        <a href="{{ url_for('main.profile') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-user w3-margin-right"></i> Profile
        </a>
        <a href="{{ url_for('main.settings') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-cog w3-margin-right"></i> Settings
        </a>
        <a href="{{ url_for('auth.logout') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-sign-out-alt w3-margin-right"></i> Logout
        </a>
    </div>
</div>

<!-- Overlay -->
<div class="w3-overlay w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" id="myOverlay"></div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="w3-panel">
        {% for category, message in messages %}
            <div class="w3-padding w3-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'yellow' }} w3-round w3-margin-bottom" 
                 id="flash-{{ loop.index }}"
                 style="position: relative; top: 35px">
                {{ message }}
                <span onclick="dismissFlash(this.parentElement)" 
                      class="w3-button w3-right w3-hover-none" 
                      style="position: absolute; right: 0; top: 0; padding: 8px 16px;">
                    Ã—
                </span>
            </div>
            <script>
                setTimeout(function() {
                    var flashMsg = document.getElementById('flash-{{ loop.index }}');
                    if (flashMsg) {
                        var opacity = 1;
                        var fadeEffect = setInterval(function() {
                            if (opacity > 0) {
                                opacity -= 0.1;
                                flashMsg.style.opacity = opacity;
                            } else {
                                clearInterval(fadeEffect);
                                flashMsg.style.display = 'none';
                            }
                        }, 50);
                    }
                }, 5000);
                
                function dismissFlash(element) {
                    element.style.display = 'none';
                }
            </script>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="w3-main" style="margin-top:46px">
    <header class="w3-container w3-padding-32 w3-center">
                <h1><b>All Courses</b></h1>
                <p class="w3-text-grey">Browse and manage your courses</p>
                {% if role == 'teacher' %}
                <a href="{{ url_for('course.create_course') }}" class="w3-button w3-green w3-round-large w3-hover-grey">
                    <i class="fas fa-plus w3-margin-right"></i> Create New Course
                </a>
                {% endif %}
            </div>
        </div>
    </header>

    <div class="w3-container">
        <div class="w3-row-padding">
            <!-- Filter Panel -->
        <div class="w3-col m4 w3-margin-bottom">
            <div class="w3-card w3-white w3-round-large">
                <div class="w3-container w3-deep-purple w3-round-large w3-padding-16">
                    <h4><i class="fas fa-filter w3-margin-right"></i> Filter Courses</h4>
                </div>
                <form method="GET" action="{{ url_for('course.courses') }}" class="w3-container w3-padding-16">
                    <p>
                        <label><i class="fas fa-calendar-day w3-margin-right"></i>Day</label>
                        <select class="w3-select w3-border w3-round-large" name="day">
                            <option value="">All Days</option>
                            {% for day in ["Saturday", "Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday"] %}
                            <option value="{{ day }}" {% if request.args.get('day') == day %}selected{% endif %}>{{ day }}</option>
                            {% endfor %}
                        </select>
                    </p>
                    <p>
                        <label><i class="fas fa-clock w3-margin-right"></i>Time</label>
                        <select class="w3-select w3-border w3-round-large" name="time">
                            <option value="">Any Time</option>
                            <option value="morning" {% if request.args.get('time') == 'morning' %}selected{% endif %}>Morning (8AM-12PM)</option>
                            <option value="afternoon" {% if request.args.get('time') == 'afternoon' %}selected{% endif %}>Afternoon (12PM-5PM)</option>
                            <option value="evening" {% if request.args.get('time') == 'evening' %}selected{% endif %}>Evening (5PM-9PM)</option>
                        </select>
                    </p>

                    {% if role == 'teacher' %}
                    <p>
                        <label>
                            <input class="w3-check" type="checkbox" name="only_my_courses"
                                   {% if request.args.get('only_my_courses') %}checked{% endif %}>
                            Only My Courses
                        </label>
                    </p>
                    {% elif role == 'student' %}
                    <p>
                        <label>
                            <input class="w3-check" type="checkbox" name="only_enrolled"
                                   {% if request.args.get('only_enrolled') %}checked{% endif %}>
                            Only Enrolled Courses
                        </label>
                        <br>
                        <label>
                            <input class="w3-check" type="checkbox" name="not_enrolled"
                                   {% if request.args.get('not_enrolled') %}checked{% endif %}>
                            Not Enrolled Courses
                        </label>
                    </p>
                    {% endif %}

                    <button type="submit" class="w3-button w3-deep-purple w3-round-large w3-block">
                        <i class="fas fa-filter w3-margin-right"></i> Apply Filters
                    </button>
                </form>
            </div>
        </div>

            <!-- Course List -->
            <div class="w3-col m8">
                {% if courses %}
                    {% for course in courses %}
                    <div class="w3-card w3-white w3-round-large w3-margin-bottom">
                        <div class="w3-container w3-padding-16">
                            <div class="w3-row">
                                <div class="w3-col m9">
                                    <h4><b>{{ course['name'] }}</b></h4>
                                    <div class="w3-text-grey">
                                        <p><i class="fas fa-user-tie w3-text-deep-purple w3-margin-right"></i>Teacher: {{ course['teacher_name'] }}</p>
                                        <p>
                                            <i class="fas fa-calendar-day w3-text-deep-purple w3-margin-right"></i>
                                            {% for schedule in course.sorted_schedules %}
                                                {{ schedule.get('day') }} at {{ schedule.get('time') }}{% if not loop.last %},      {% endif %}
                                            {% endfor %}
                                        </p>
                                        <p><i class="fas fa-users w3-text-deep-purple w3-margin-right"></i>{{ course['current_students'] }}/{{ course['max_students'] }} students</p>
                                        <p><i class="fas fa-dollar-sign w3-text-deep-purple w3-margin-right"></i>Price: 
                                            {% if not course.get('price')==0.0 %}
                                                ${{ "%.2f"|format(course.get('price', 0.0)) }}
                                            {% else %}
                                                Free
                                            {% endif %}</p>
                                    </div>
                                </div>
                                <div class="w3-col m3 w3-center w3-padding-16">
                                    {% if role == 'student' %}
                                        {% if course['id'] in enrolled_course_ids %}
                                            <p class="w3-text-green"><i class="fas fa-check-circle"></i> Enrolled</p>
                                        {% else %}
                                            {% if course['current_students'] < course['max_students'] %}
                                                <form action="{{ url_for('course.enroll') }}" method="POST">
                                                    <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                                    <button type="submit" class="w3-button w3-green w3-round-large">
                                                        <i class="fas fa-plus"></i> Enroll
                                                    </button>
                                                </form>
                                            {% else %}
                                                <p class="w3-text-red"><i class="fas fa-times-circle"></i> Course Full</p>
                                            {% endif %}
                                        {% endif %}
                                    {% endif %}
                                    <a href="{{ url_for('course.course_detail', course_id=course['id']) }}" class="w3-button w3-light-grey w3-round-large w3-margin-top">
                                        <i class="fas fa-eye"></i> Details
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="w3-panel w3-pale-yellow w3-round-large">
                        <p><i class="fas fa-info-circle"></i> No courses found matching your criteria.</p>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

</div>

<!-- Sidebar Scripts -->
<script>
    function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("myOverlay").style.display = "block";
    }

    function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("myOverlay").style.display = "none";
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const onlyEnrolled = document.querySelector('input[name="only_enrolled"]');
        const notEnrolled = document.querySelector('input[name="not_enrolled"]');

        if (onlyEnrolled && notEnrolled) {
            onlyEnrolled.addEventListener('change', function () {
                if (this.checked) {
                    notEnrolled.checked = false;
                }
            });

            notEnrolled.addEventListener('change', function () {
                if (this.checked) {
                    onlyEnrolled.checked = false;
                }
            });
        }
    });
</script>

</body>
</html>