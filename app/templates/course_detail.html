<!DOCTYPE html>
<html>
<head>
    <title>{{ course['name'] }} - Course Details</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='w3.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .w3-hover-rounded:hover {
            border-radius: 8px;
        }
        .course-header {
            background-color: #f8f9fa;
            padding: 2rem;
            border-radius: 0.5rem;
        }
        .student-list {
            max-height: 300px;
            overflow-y: auto;
        }        
        .w3-file-icon {
            width: 24px;
            text-align: center;
            margin-right: 8px;
        }
        .w3-responsive {
            overflow-x: auto;
        }
        .w3-material-card {
            transition: transform 0.3s;
        }
        .w3-material-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2);
        }
        .w3-tablink {
            border-radius: 8px 8px 0 0;
        }
        .tab-content {
            display: none;
        }
    </style>
</head>

<body class="w3-light-grey">

<!-- Top Navigation -->
{% if role == 'admin' %}
    <div class="w3-top">
        <div class="w3-bar w3-deep-purple w3-card">
            <a href="/admin/dashboard" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="/admin/users" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-users"></i> Users
            </a> 
            <a href="/admin/courses" class="w3-bar-item w3-button w3-padding-large w3-round-large">
                <i class="fas fa-book"></i> Courses
            </a>
            <a href="/admin/enrollments" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-link"></i> Enrollments
            </a>
            <a href="/admin/logs" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-clipboard-list"></i> Logs
            </a>
            <button class="w3-button w3-padding-large w3-right w3-hover-rounded" onclick="w3_open()">
                <i class="fas fa-user-circle"></i> {{ username }}
            </button>
        </div>
    </div>
{% else %}
    <div class="w3-top">
        <div class="w3-bar w3-deep-purple w3-card">
            <a href="{{ url_for('main.dashboard') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </a>
            <a href="{{ url_for('course.courses') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-book"></i> Courses
            </a> 
            <a href="{{ url_for('exam.exams_page') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-file-signature"></i> Exams
            </a>
            <a href="{{ url_for('course.calendar') }}" class="w3-bar-item w3-button w3-padding-large w3-hover-rounded">
                <i class="fas fa-calendar"></i> Calendar
            </a>
            <button class="w3-button w3-padding-large w3-right w3-hover-rounded" onclick="w3_open()">
                <i class="fas fa-user-circle"></i> {{ username }}
            </button>
        </div>
    </div>
{% endif %}

<!-- Right Sidebar -->
<div class="w3-sidebar w3-bar-block w3-white w3-card w3-animate-right" 
     style="width:280px;right:0;display:none;z-index:3" id="mySidebar">
    <button onclick="w3_close()" class="w3-bar-item w3-button w3-large w3-right-align">
        <i class="fas fa-times"></i>
    </button>
    <div class="w3-container w3-padding-16 w3-center">
        <div class="w3-display-container" style="width:100%"></div>
        <h3 class="w3-margin-top"><b>{{ username }}</b></h3>
        <span class="w3-tag w3-round w3-deep-purple">{{ role|capitalize }}</span>
    </div>
    <div class="w3-bar-block">
        <a href="{{ url_for('main.profile') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-user w3-margin-right"></i> Profile
        </a>
        <a href="{{ url_for('main.settings') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-cog w3-margin-right"></i> Settings
        </a>
        <a href="{{ url_for('auth.logout') }}" class="w3-bar-item w3-button w3-padding">
            <i class="fas fa-sign-out-alt w3-margin-right"></i> Logout
        </a>
    </div>
</div>

<!-- Overlay -->
<div class="w3-overlay w3-animate-opacity" onclick="w3_close()" style="cursor:pointer" id="myOverlay"></div>

<!-- Flash Messages -->
{% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="w3-panel">
        {% for category, message in messages %}
            <div class="w3-padding w3-{{ 'green' if category == 'success' else 'red' if category == 'error' else 'yellow' }} w3-round w3-margin-bottom" 
                 id="flash-{{ loop.index }}"
                 style="position: relative; top: 35px">
                {{ message }}
                <span onclick="dismissFlash(this.parentElement)" 
                      class="w3-button w3-right w3-hover-none" 
                      style="position: absolute; right: 0; top: 0; padding: 8px 16px;">
                    Ã—
                </span>
            </div>
            <script>
                setTimeout(function() {
                    var flashMsg = document.getElementById('flash-{{ loop.index }}');
                    if (flashMsg) {
                        var opacity = 1;
                        var fadeEffect = setInterval(function() {
                            if (opacity > 0) {
                                opacity -= 0.1;
                                flashMsg.style.opacity = opacity;
                            } else {
                                clearInterval(fadeEffect);
                                flashMsg.style.display = 'none';
                            }
                        }, 50);
                    }
                }, 5000);
                
                function dismissFlash(element) {
                    element.style.display = 'none';
                }
            </script>
        {% endfor %}
        </div>
    {% endif %}
{% endwith %}

<div class="w3-main" style="margin-top:46px;margin-right:0">
    <!-- Course Header -->
    <div class="w3-container w3-padding-32">
        <div class="w3-panel course-header w3-card">
            <div class="w3-row">
                <div class="w3-twothird">
                    <h1><b>{{ course['name'] }}</b></h1>
                    <p class="w3-large">Taught by {{ course['teacher_name'] }} </p>
                </div>
                <div class="w3-third w3-right-align">
                <span class="w3-tag w3-round w3-{{ 'red' if is_full else 'green' }} w3-large">
                    {{ course.get('current_students', 0) }}/{{ course.get('max_students', 0) }} Students
                </span>
                <div class="w3-margin-top">
                    <p>
                        <i class="fas fa-dollar-sign w3-text-deep-purple"></i> 
                        Price: ${{ "%.2f"|format(course.get('price', 0.0)) }}
                    </p>
                    <p>
                        <i class="fas fa-clock w3-text-deep-purple"></i> 
                        {{ hours_per_week }} hours/week
                    </p>
                    <p>
                    <i class="fas fa-calendar-day w3-text-deep-purple"></i> 
                        {% for schedule in sorted_schedules %}
                            {{ schedule.get('day', 'N/A') }} at {{ schedule.get('time', 'N/A') }}{% if not loop.last %}, {% endif %}
                        {% endfor %}
                    </p>
                </div>
            </div>
            </div>
        </div>
    </div>

    <div class="w3-container">
        <div class="w3-row-padding">
            <!-- Left Column - Course Details -->
            <div class="w3-twothird">
                <!-- Tab Navigation -->
                <div class="w3-bar w3-light-grey w3-round">
                    <button class="w3-bar-item w3-button w3-tablink w3-deep-purple" onclick="openTab(event, 'Info')"><i class="fas fa-info-circle"></i> Info</button>
                    <button class="w3-bar-item w3-button w3-tablink" onclick="openTab(event, 'Materials')"><i class="fas fa-file-alt"></i> Materials</button>
                    <button class="w3-bar-item w3-button w3-tablink" onclick="openTab(event, 'Exams')"><i class="fas fa-file-signature"></i> Exams</button>
                    {% if is_teacher_of_course or role == 'admin' %}
                    <button class="w3-bar-item w3-button w3-tablink" onclick="openTab(event, 'Students')"><i class="fas fa-users"></i> Students</button>
                    {% endif %}
                </div>

                <!-- Info Tab -->
                <div id="Info" class="tab-content w3-panel w3-white w3-round-large w3-card w3-padding">
                    <div class="w3-row-padding w3-margin-top">
                        <div class="w3-half">
                            <div class="w3-panel">
                                <h4><b><i class="fas fa-clock w3-text-deep-purple"></i> Schedule</b></h4>
                                {% for schedule in sorted_schedules %}
                                <div class="w3-card w3-round-large w3-padding-small w3-margin-bottom">
                                    <p><i class="fas fa-calendar w3-margin-right"></i> {{ schedule.get('day', 'N/A') }}</p>
                                    <p><i class="fas fa-clock w3-margin-right"></i> {{ schedule.get('time', 'N/A') }}</p>
                                    <p><i class="fas fa-hourglass w3-margin-right"></i> {{ schedule.get('duration', 'N/A') }} hour session</p>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="w3-half">
                            <div class="w3-panel">
                                <h4><b><i class="fas fa-chalkboard-teacher w3-text-deep-purple"></i> Instructor</b></h4>
                                <p>{{ course['teacher_name'] }}</p>
                                <h4 class="w3-margin-top"><b><i class="fas fa-hashtag w3-text-deep-purple"></i> Course ID</b></h4>
                                <p>{{ course['id'] }}</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Course Materials Tab -->
                <div id="Materials" class="tab-content w3-panel w3-white w3-round-large w3-card w3-padding">
                    {% if is_teacher_of_course %}
                    <div class="w3-panel w3-light-grey w3-round-large w3-padding">
                        <form method="post" enctype="multipart/form-data" 
                              action="{{ url_for('course.upload_material', course_id=course['id']) }}" 
                              onsubmit="return validateFile()">
                            <div class="w3-row-padding">
                                <div class="w3-col s12 m8">
                                    <input class="w3-input w3-border w3-round-large" type="file" name="file" id="fileInput" required>
                                </div>
                                <div class="w3-col s12 m4">
                                    <button class="w3-button w3-deep-purple w3-round-large w3-block" type="submit">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                            </div>
                            <div class="w3-row-padding w3-margin-top">
                                <div class="w3-col s12">
                                    <input class="w3-input w3-border w3-round-large" type="text" name="description" 
                                           placeholder="File description (optional)">
                                </div>
                            </div>
                            <p class="w3-small w3-text-grey">
                                <i class="fas fa-info-circle"></i> Allowed: PDF, DOC, PPT, MP4, MP3, JPG, PNG (Max 500MB)
                            </p>
                        </form>
                    </div>
                    {% endif %}
                    
                    {% if course.get('materials') %}
                    <div class="w3-responsive">
                        <table class="w3-table-all w3-hoverable">
                            <thead>
                                <tr class="w3-deep-purple">
                                    <th>File</th>
                                    <th>Size</th>
                                    <th>Uploaded</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for material in course['materials'] %}
                                <tr>
                                    <td>
                                        <i class="fas 
                                            {% if material['filename'].endswith('.pdf') %}fa-file-pdf
                                            {% elif material['filename'].endswith(('.doc', '.docx')) %}fa-file-word
                                            {% elif material['filename'].endswith(('.ppt', '.pptx')) %}fa-file-powerpoint
                                            {% elif material['filename'].endswith(('.mp4', '.mov', '.avi')) %}fa-file-video
                                            {% elif material['filename'].endswith(('.mp3', '.wav')) %}fa-file-audio
                                            {% elif material['filename'].endswith(('.jpg', '.png')) %}fa-file-image
                                            {% else %}fa-file{% endif %} w3-margin-right"></i>
                                        {{ material['filename'] }}
                                        {% if material['description'] %}
                                        <p class="w3-small w3-text-grey">{{ material['description'] }}</p>
                                        {% endif %}
                                    </td>
                                    <td>{{ (material['size'] / (1024 * 1024))|round(2) }} MB</td>
                                    <td>{{ material['upload_date']|datetimeformat('%b %d, %Y') }}</td>
                                    <td>
                                        {% set filename_lower = material['filename']|lower %}
                                        {% if filename_lower.endswith('.pdf') or 
                                            filename_lower.endswith('.jpg') or 
                                            filename_lower.endswith('.jpeg') or 
                                            filename_lower.endswith('.png') or 
                                            filename_lower.endswith('.gif') or 
                                            filename_lower.endswith('.txt') or
                                            filename_lower.endswith('.mp4') or
                                            filename_lower.endswith('.mp3') %}
                                        <a href="{{ url_for('course.view_material', course_id=course['id'], filename=material['filename']) }}" 
                                        target="_blank" class="w3-button w3-blue w3-tiny w3-round" style="margin-right: 5px;">
                                        <i class="fas fa-eye"></i> View
                                        </a>
                                        {% endif %}
                                        <a href="{{ url_for('course.download_material', course_id=course['id'], filename=material['filename']) }}" 
                                        class="w3-button w3-green w3-tiny w3-round">
                                        <i class="fas fa-download"></i> Download
                                        </a>
                                        {% if is_teacher_of_course or role == 'admin' %}
                                        <form method="post" 
                                            action="{{ url_for('course.delete_material', course_id=course['id'], filename=material['filename']) }}"
                                            onsubmit="return confirm('Are you sure you want to delete this file?')"
                                            style="display: inline-block; margin-left: 5px; vertical-align: middle;">
                                            <button type="submit" class="w3-button w3-red w3-tiny w3-round">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="w3-panel w3-pale-yellow w3-round-large"><p><i class="fas fa-info-circle"></i> No materials have been uploaded yet.</p></div>
                    {% endif %}
                </div>

                <!-- Exams Tab -->
                <div id="Exams" class="tab-content w3-panel w3-white w3-round-large w3-card w3-padding">
                    {% if is_teacher_of_course %}
                    <a href="{{ url_for('exam.create_exam', course_id=course['id']) }}" class="w3-button w3-green w3-round-large w3-margin-bottom">
                        <i class="fas fa-plus"></i> Create New Exam
                    </a>
                    {% endif %}

                    {% if exams %}
                    <ul class="w3-ul w3-hoverable">
                        {% for exam in exams %}
                        <li class="w3-bar">
                            <div class="w3-bar-item">
                                <span class="w3-large">{{ exam.title }}</span><br>
                                <span class="w3-small w3-text-grey">{{ exam.questions|length }} questions, {{ exam.duration_minutes }} mins</span>
                            </div>
                            <div class="w3-bar-item w3-right">
                                {% if role == 'student' %}
                                    {% if exam.id in student_submissions %}
                                        <span class="w3-tag w3-green w3-round">Submitted</span>
                                        <p class="w3-small">Score: {{ student_submissions[exam.id].score }}%</p>
                                    {% else %}
                                        <a href="{{ url_for('exam.take_exam', exam_id=exam.id) }}" class="w3-button w3-blue w3-round">
                                            <i class="fas fa-edit"></i> Take Exam
                                        </a>
                                    {% endif %}
                                {% elif is_teacher_of_course or role == 'admin' %}
                                    <a href="{{ url_for('exam.exam_results', exam_id=exam.id) }}" class="w3-button w3-deep-purple w3-round w3-small">
                                        <i class="fas fa-poll"></i> Results
                                    </a>
                                    <form action="{{ url_for('exam.delete_exam', exam_id=exam.id) }}" method="POST" style="display:inline-block; margin-left:5px;" onsubmit="return confirm('Are you sure you want to delete this exam and all its submissions?');">
                                        <button type="submit" class="w3-button w3-red w3-round w3-small">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </form>
                                {% endif %}
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                    {% else %}
                    <div class="w3-panel w3-pale-yellow w3-round-large"><p><i class="fas fa-info-circle"></i> No exams for this course yet.</p></div>
                    {% endif %}
                </div>
                
                <!-- Student List Tab -->
                {% if is_teacher_of_course or role == 'admin' %}
                <div id="Students" class="tab-content w3-panel w3-white w3-round-large w3-card w3-padding">
                    {% if students %}
                        <ul class="w3-ul student-list">
                            {% for student in students %}
                            <li class="w3-bar">
                                <div class="w3-bar-item">
                                    <span class="w3-large">{{ student.username }}</span><br>
                                    <span class="w3-small">{{ student.email }}</span>
                                </div>
                                <div class="w3-bar-item w3-bar-right">
                                    {% if is_teacher_of_course %}
                                        <form action="{{ url_for('course.remove_student') }}" method="POST">
                                            <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                            <input type="hidden" name="student_email" value="{{ student.email }}">
                                            <button type="submit" class="w3-button w3-red w3-small w3-round-large w3-margin-top" 
                                                    onclick="return confirm('Are you sure you want to remove this student?')">
                                                <i class="fas fa-user-minus"></i> Remove
                                            </button>
                                        </form>
                                    {% elif role == 'admin' %}
                                        <form action="{{ url_for('admin.admin_delete_enrollment') }}" method="POST">
                                            <input type="hidden" name="student_email" value="{{ student.email }}">
                                            <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                            <button type="submit" class="w3-button w3-red w3-small w3-round-large w3-margin-top" 
                                                    onclick="return confirm('Are you sure you want to remove this student from the course?')">
                                                <i class="fas fa-unlink"></i> Remove  
                                            </button>
                                        </form>
                                    {% endif %}  
                                </div>
                            </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <div class="w3-panel w3-pale-yellow w3-round-large"><p><i class="fas fa-info-circle"></i> No students have enrolled yet.</p></div>
                    {% endif %}
                </div>
                {% endif %}
            </div>

            <!-- Right Column - Actions -->
            <div class="w3-third">
                 <div class="w3-panel w3-white w3-round-large w3-card w3-padding">
                    <h2 class="w3-text-deep-purple"><i class="fas fa-cogs"></i> Actions</h2>
                    <div class="w3-center w3-padding-16">
                        {% if role == 'student' %}
                            {% if is_enrolled %}
                                <form action="{{ url_for('course.unenroll') }}" method="POST" onsubmit="return confirm('Are you sure you want to unenroll? You will not receive a refund for this course.');">
                                    <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                    <button type="submit" class="w3-button w3-red w3-round-large w3-padding-large w3-block">
                                        <i class="fas fa-user-minus w3-margin-right"></i> Unenroll
                                    </button>
                                </form>
                            {% else %}
                                {% if is_full %}
                                    <button class="w3-button w3-grey w3-round-large w3-padding-large w3-block" disabled>
                                        <i class="fas fa-lock w3-margin-right"></i> Course Full
                                    </button>
                                {% else %}
                                    <form action="{{ url_for('course.enroll') }}" method="POST">
                                        <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                        <button type="submit" class="w3-button w3-deep-purple w3-round-large w3-padding-large w3-block">
                                            <i class="fas fa-user-plus w3-margin-right"></i> Enroll Now
                                        </button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        {% elif is_teacher_of_course %}
                            <form action="{{ url_for('course.delete_course') }}" method="POST" class="w3-margin-bottom">
                                <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                <button type="submit" class="w3-button w3-red w3-round-large w3-padding-large w3-block"
                                        onclick="return confirm('Are you sure you want to delete this course? This action cannot be undone.')">
                                    <i class="fas fa-trash-alt w3-margin-right"></i> Delete Course
                                </button>
                            </form>
                        {% elif role == 'admin' %} 
                            <form action="{{ url_for('admin.admin_delete_course') }}" method="post" class="w3-margin-bottom">
                                <input type="hidden" name="course_id" value="{{ course['id'] }}">
                                <button type="submit" class="w3-button w3-red w3-round-large w3-padding-large w3-block"
                                        onclick="return confirm('Are you sure you want to delete this course? This action cannot be undone.')">
                                    <i class="fas fa-trash-alt w3-margin-right"></i> Delete Course
                                </button>
                            </form>
                            <a href="{{ url_for('admin.admin_courses') }}" class="w3-button w3-light-grey w3-round-large w3-padding-large w3-block w3-margin-top">
                                <i class="fas fa-arrow-left w3-margin-right"></i> Back to Courses
                            </a>
                        {% endif %}
                        {% if role != 'admin' %} 
                        <a href="{{ url_for('course.courses') }}" class="w3-button w3-light-grey w3-round-large w3-padding-large w3-block w3-margin-top">
                            <i class="fas fa-arrow-left w3-margin-right"></i> Back to Courses
                        </a>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Scripts -->
<script>
    function openTab(evt, tabName) {
        var i, x, tablinks;
        x = document.getElementsByClassName("tab-content");
        for (i = 0; i < x.length; i++) {
            x[i].style.display = "none";
        }
        tablinks = document.getElementsByClassName("w3-tablink");
        for (i = 0; i < tablinks.length; i++) {
            tablinks[i].className = tablinks[i].className.replace(" w3-deep-purple", "");
        }
        document.getElementById(tabName).style.display = "block";
        evt.currentTarget.className += " w3-deep-purple";
    }
    // Open the first tab by default
    document.addEventListener("DOMContentLoaded", function(){
        document.getElementsByClassName("w3-tablink")[0].click();
    });

    function w3_open() {
        document.getElementById("mySidebar").style.display = "block";
        document.getElementById("myOverlay").style.display = "block";
    }

    function w3_close() {
        document.getElementById("mySidebar").style.display = "none";
        document.getElementById("myOverlay").style.display = "none";
    }
    
    // File upload validation
    function validateFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        const maxSize = 500 * 1024 * 1024; // 500MB
        const allowedExtensions = ['pdf', 'doc', 'docx', 'ppt', 'pptx', 'mp4', 'mov', 'avi', 'jpg', 'png', 'mp3', 'wav'];
        
        if (file) {
            if (file.size > maxSize) {
                alert('File is too large. Maximum size is 500MB.');
                return false;
            }
            const extension = file.name.split('.').pop().toLowerCase();
            if (!allowedExtensions.includes(extension)) {
                alert('File type not allowed.');
                return false;
            }
        } else {
            alert('Please select a file.');
            return false;
        }
        return true;
    }
</script>

</body>
</html>